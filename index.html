<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰äººç‚¸é£æœº Â· å®æ—¶åŒæ­¥ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1e2c, #2d3748);
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 12px;
            color: #e2e8f0;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(26, 32, 44, 0.95);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid #4a5568;
        }
        h1 { text-align: center; color: #e2e8f0; margin-bottom: 20px; }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn-primary { background: #4299e1; }
        .btn-success { background: #48bb78; }
        .btn-warning { background: #ed8936; }
        .btn:active { transform: scale(0.98); }
        
        .hidden { display: none !important; }
        
        .room-header {
            background: #2d3748;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .room-code {
            font-size: 42px;
            font-weight: bold;
            text-align: center;
            color: #68d391;
            letter-spacing: 12px;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        .player-card {
            background: #2d3748;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #4a5568;
        }
        .player-card.active { border-color: #48bb78; background: #22543d; }
        .player-card.ready { border-color: #48bb78; background: #276749; }
        .player-card.eliminated { border-color: #f56565; background: #742a2a; opacity: 0.6; }
        
        .grid-container {
            background: #2d3748;
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            aspect-ratio: 1;
        }
        .cell {
            aspect-ratio: 1;
            background: #1a1e2c;
            border: 1px solid #4a5568;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        .cell.own-plane-head { background: #fbbf24; color: black; }
        .cell.own-plane-body { background: #48bb78; }
        .cell.enemy-unknown { background: #1a1e2c; }
        .cell.hit-head { background: #f56565; }
        .cell.hit-body { background: #fbbf24; color: black; }
        .cell.miss { background: #4299e1; }
        .cell.enemy-cell { cursor: pointer; }
        .cell.enemy-cell:hover { background: #4a5568; }
        
        .turn-indicator {
            background: #48bb78;
            color: white;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .target-selector {
            display: flex;
            gap: 12px;
            margin: 15px 0;
        }
        .target-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            background: #4299e1;
        }
        .target-btn.active {
            border: 3px solid #fbbf24;
            transform: scale(1.02);
        }
        
        .link-box {
            background: #1a1e2c;
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            margin-bottom: 15px;
            border-left: 4px solid #48bb78;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœˆï¸ ä¸‰äººç‚¸é£æœº Â· å®æ—¶åŒæ­¥</h1>
        
        <div id="menu">
            <button class="btn btn-primary" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
            <button class="btn btn-success" onclick="showJoin()">åŠ å…¥æˆ¿é—´</button>
        </div>
        
        <div id="joinInput" class="hidden">
            <div class="room-header">
                <h2 style="text-align: center;">ğŸ”‘ è¾“å…¥æˆ¿é—´å·</h2>
                <input type="text" id="roomCodeInput" placeholder="ä¾‹å¦‚: ABC123" 
                       style="width: 100%; padding: 18px; font-size: 24px; text-align: center; 
                              background: #1a1e2c; border: 2px solid #4a5568; border-radius: 12px;
                              color: white; letter-spacing: 4px;" maxlength="6">
            </div>
            <button class="btn btn-success" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            <button class="btn btn-warning" onclick="backToMenu()">è¿”å›</button>
        </div>
        
        <div id="roomInfo" class="hidden">
            <div class="room-header">
                <div style="text-align: center; margin-bottom: 10px;">æˆ¿é—´å·</div>
                <div class="room-code" id="roomCodeDisplay">ABC123</div>
            </div>
            
            <div style="background: #2d3748; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px; color: #fbbf24; font-weight: bold;">ğŸ“‹ é‚€è¯·é“¾æ¥ï¼ˆæ¯äººç‚¹è‡ªå·±çš„ï¼‰</div>
                <div id="shareLink"></div>
                <button class="btn btn-success" style="margin-top: 15px;" onclick="copyAllLinks()">ğŸ“‹ å¤åˆ¶æ‰€æœ‰é“¾æ¥</button>
            </div>
            
            <div class="players-grid" id="playerList"></div>
            
            <button id="readyBtn" class="btn btn-success" onclick="toggleReady()">å‡†å¤‡æ¸¸æˆ</button>
            <button class="btn btn-warning" onclick="backToMenu()">è¿”å›</button>
        </div>
        
        <div id="gamePage" class="hidden">
            <div id="turnDisplay" class="turn-indicator">âš”ï¸ ç­‰å¾…å¼€å§‹...</div>
            
            <div id="targetSelector" class="target-selector hidden"></div>
            
            <div class="grid-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span>âœˆï¸ æˆ‘çš„é˜µåœ°</span>
                    <span id="myPlanesLeft">é£æœº: 3</span>
                </div>
                <div id="myGrid" class="grid"></div>
            </div>
            
            <div class="grid-container" id="enemyBoard1">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span id="enemyTitle1">ğŸ‘¤ ç©å®¶1 çš„é˜µåœ°</span>
                    <span id="enemyPlanes1">é£æœº: 3</span>
                </div>
                <div id="enemyGrid1" class="grid"></div>
            </div>
            
            <div class="grid-container" id="enemyBoard2">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span id="enemyTitle2">ğŸ‘¤ ç©å®¶2 çš„é˜µåœ°</span>
                    <span id="enemyPlanes2">é£æœº: 3</span>
                </div>
                <div id="enemyGrid2" class="grid"></div>
            </div>
            
            <div class="grid-container" id="enemyBoard3">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span id="enemyTitle3">ğŸ‘¤ ç©å®¶3 çš„é˜µåœ°</span>
                    <span id="enemyPlanes3">é£æœº: 3</span>
                </div>
                <div id="enemyGrid3" class="grid"></div>
            </div>
            
            <button class="btn btn-warning" onclick="backToMenu()">é€€å‡ºæ¸¸æˆ</button>
        </div>
    </div>

    <script>
        // ==================== é£æœºå½¢çŠ¶ ====================
        const PLANE_SHAPE = [
            [0, 0, 2, 0, 0],
            [1, 1, 1, 1, 1],
            [0, 0, 1, 0, 0],
            [0, 1, 1, 1, 0]
        ];
        
        // ==================== ç”Ÿæˆæ£‹ç›˜ ====================
        function generateBoard() {
            const board = Array(10).fill().map(() => Array(10).fill(0));
            for (let p = 0; p < 3; p++) {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 1000) {
                    const row = Math.floor(Math.random() * 7);
                    const col = Math.floor(Math.random() * 6);
                    if (canPlace(board, row, col)) {
                        placePlane(board, row, col);
                        placed = true;
                    }
                    attempts++;
                }
            }
            return board;
        }
        
        function canPlace(board, r, c) {
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 5; j++) {
                    if (PLANE_SHAPE[i][j] !== 0) {
                        const nr = r + i, nc = c + j;
                        if (nr >= 10 || nc >= 10) return false;
                        if (board[nr][nc] !== 0) return false;
                    }
                }
            }
            return true;
        }
        
        function placePlane(board, r, c) {
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 5; j++) {
                    if (PLANE_SHAPE[i][j] !== 0) {
                        board[r + i][c + j] = PLANE_SHAPE[i][j];
                    }
                }
            }
        }

        // ==================== æœ¬åœ°å­˜å‚¨ç®¡ç† ====================
        const STORAGE_KEY = 'plane_game_rooms';
        
        function getRoom(roomCode) {
            const rooms = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            return rooms[roomCode];
        }
        
        function saveRoom(roomCode, roomData) {
            const rooms = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            rooms[roomCode] = roomData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
        }
        
        // ==================== å½“å‰ç©å®¶çŠ¶æ€ ====================
        let myPlayerNum = null;
        let myRoomCode = null;
        let syncInterval = null;
        
        // ==================== æˆ¿é—´ç®¡ç† ====================
        function createRoom() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
            
            const roomData = {
                code: code,
                players: [1],
                ready: {1: false},
                boards: {
                    1: generateBoard(),
                    2: generateBoard(),
                    3: generateBoard()
                },
                attacks: {},
                planes: {1: 3, 2: 3, 3: 3},
                eliminated: {},
                turn: 1,
                started: false
            };
            
            saveRoom(code, roomData);
            
            myRoomCode = code;
            myPlayerNum = 1;
            
            showRoom();
            
            // ç”Ÿæˆä¸‰ä¸ªé“¾æ¥
            const baseUrl = window.location.href.split('?')[0];
            const link1 = baseUrl + '?room=' + code + '&player=1';
            const link2 = baseUrl + '?room=' + code + '&player=2';
            const link3 = baseUrl + '?room=' + code + '&player=3';
            
            document.getElementById('shareLink').innerHTML = `
                <div class="link-box" style="border-left-color: #fbbf24;">
                    <div style="color: #fbbf24; margin-bottom: 5px;">ğŸ‘‘ ç©å®¶1ï¼ˆä½ çš„é“¾æ¥ï¼‰</div>
                    <div style="font-size: 14px;">${link1}</div>
                </div>
                <div class="link-box" style="border-left-color: #4299e1;">
                    <div style="color: #4299e1; margin-bottom: 5px;">ğŸ‘¤ ç©å®¶2ï¼ˆå‘ç»™ç¬¬ä¸€ä¸ªå¥½å‹ï¼‰</div>
                    <div style="font-size: 14px;">${link2}</div>
                </div>
                <div class="link-box" style="border-left-color: #48bb78;">
                    <div style="color: #48bb78; margin-bottom: 5px;">ğŸ‘¤ ç©å®¶3ï¼ˆå‘ç»™ç¬¬äºŒä¸ªå¥½å‹ï¼‰</div>
                    <div style="font-size: 14px;">${link3}</div>
                </div>
            `;
            
            startSync();
        }
        
        function showJoin() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('joinInput').classList.remove('hidden');
        }
        
        function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.toUpperCase();
            if (code.length !== 6) { alert('è¯·è¾“å…¥6ä½æˆ¿é—´å·'); return; }
            
            const urlParams = new URLSearchParams(window.location.search);
            let playerNum = urlParams.get('player');
            
            if (!playerNum) {
                const roomData = getRoom(code);
                if (!roomData) { alert('æˆ¿é—´ä¸å­˜åœ¨'); return; }
                
                for (let i = 2; i <= 3; i++) {
                    if (!roomData.players.includes(i)) {
                        playerNum = i;
                        break;
                    }
                }
            }
            
            if (!playerNum) { alert('æˆ¿é—´å·²æ»¡'); return; }
            
            let roomData = getRoom(code);
            if (!roomData) {
                // è‡ªåŠ¨åˆ›å»ºæˆ¿é—´
                roomData = {
                    code: code,
                    players: [],
                    ready: {},
                    boards: {
                        1: generateBoard(),
                        2: generateBoard(),
                        3: generateBoard()
                    },
                    attacks: {},
                    planes: {1: 3, 2: 3, 3: 3},
                    eliminated: {},
                    turn: 1,
                    started: false
                };
            }
            
            if (!roomData.players.includes(parseInt(playerNum))) {
                roomData.players.push(parseInt(playerNum));
                roomData.ready[playerNum] = false;
                saveRoom(code, roomData);
            }
            
            myRoomCode = code;
            myPlayerNum = parseInt(playerNum);
            
            showRoom();
            startSync();
        }
        
        function showRoom() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('joinInput').classList.add('hidden');
            document.getElementById('roomInfo').classList.remove('hidden');
            
            document.getElementById('roomCodeDisplay').innerText = myRoomCode;
            
            updateUI();
        }
        
        function updateUI() {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨
            let html = '';
            for (let i = 1; i <= 3; i++) {
                const joined = roomData.players.includes(i);
                const you = i === myPlayerNum;
                const ready = roomData.ready[i];
                const dead = roomData.eliminated[i];
                
                if (joined) {
                    html += `<div class="player-card ${ready ? 'ready' : ''} ${you ? 'active' : ''} ${dead ? 'eliminated' : ''}">
                                <div style="font-size: 18px;">ğŸ‘¤ ç©å®¶${i} ${you ? '(ä½ )' : ''}</div>
                                <div style="font-size: 14px;">${dead ? 'âŒ å·²æ·˜æ±°' : (ready ? 'âœ“ å·²å‡†å¤‡' : 'â³ å‡†å¤‡ä¸­')}</div>
                            </div>`;
                } else {
                    html += `<div class="player-card" style="opacity: 0.5;">
                                <div style="font-size: 18px;">ğŸ‘¤ ç­‰å¾…ç©å®¶${i}...</div>
                            </div>`;
                }
            }
            document.getElementById('playerList').innerHTML = html;
            
            // æ›´æ–°å‡†å¤‡æŒ‰é’®
            const btn = document.getElementById('readyBtn');
            if (roomData.ready[myPlayerNum]) {
                btn.innerText = 'å–æ¶ˆå‡†å¤‡';
                btn.style.background = '#f56565';
            } else {
                btn.innerText = 'å‡†å¤‡æ¸¸æˆ';
                btn.style.background = '#48bb78';
            }
            
            // æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨å¼€å§‹
            if (roomData.players.length === 3 && 
                roomData.players.every(p => roomData.ready[p]) && 
                !roomData.started) {
                roomData.started = true;
                roomData.turn = 1;
                saveRoom(myRoomCode, roomData);
                startGame();
            }
            
            // å¦‚æœæ¸¸æˆå·²ç»å¼€å§‹ï¼Œæ›´æ–°æ¸¸æˆç•Œé¢
            if (roomData.started && document.getElementById('gamePage').classList.contains('hidden')) {
                document.getElementById('roomInfo').classList.add('hidden');
                document.getElementById('gamePage').classList.remove('hidden');
                refreshGameUI();
            }
        }
        
        function toggleReady() {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            roomData.ready[myPlayerNum] = !roomData.ready[myPlayerNum];
            saveRoom(myRoomCode, roomData);
            updateUI();
        }
        
        function copyAllLinks() {
            const links = document.querySelectorAll('.link-box div:last-child');
            let text = '';
            links.forEach((link, index) => {
                text += `ç©å®¶${index + 1}: ${link.innerText}\n\n`;
            });
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… ä¸‰ä¸ªé“¾æ¥å·²å¤åˆ¶ï¼');
            });
        }
        
        // ==================== æ¸¸æˆæ ¸å¿ƒ ====================
        function startGame() {
            document.getElementById('roomInfo').classList.add('hidden');
            document.getElementById('gamePage').classList.remove('hidden');
            refreshGameUI();
        }
        
        function refreshGameUI() {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            renderMyBoard(roomData);
            renderAllEnemyBoards(roomData);
            updateTurnDisplay(roomData);
            
            if (isMyTurn(roomData)) {
                showTargetSelector(roomData);
            } else {
                hideTargetSelector();
            }
        }
        
        // ã€æ–°å¢åŠŸèƒ½ã€‘è‡ªå·±çš„åŒºåŸŸè¢«ç‚¸ååœ¨è‡ªå·±çš„æ£‹ç›˜ä¸Šæ˜¾ç¤ºæ ‡è®°
        function renderMyBoard(roomData) {
            const grid = document.getElementById('myGrid');
            grid.innerHTML = '';
            const board = roomData.boards[myPlayerNum];
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    // ========== æ–°å¢ï¼šæ£€æµ‹æ•Œæ–¹æ”»å‡» ==========
                    // éå†æ‰€æœ‰æ•Œäººï¼Œçœ‹æ˜¯å¦æœ‰æ”»å‡»å‘½ä¸­è‡ªå·±çš„è¿™ä¸ªæ ¼å­
                    let isHitByEnemy = false;
                    let isHeadHit = false;
                    
                    for (let enemy = 1; enemy <= 3; enemy++) {
                        if (enemy !== myPlayerNum) {  // æ•Œæ–¹ç©å®¶
                            const attackKey = `${myPlayerNum}-${i}-${j}`;  // æ³¨æ„æ ¼å¼ï¼šè¢«æ”»å‡»è€…-è¡Œ-åˆ—
                            const attack = roomData.attacks[attackKey];
                            if (attack) {
                                isHitByEnemy = true;
                                isHeadHit = attack.head;
                                break;
                            }
                        }
                    }
                    
                    // å…ˆæ˜¾ç¤ºè‡ªå·±çš„é£æœº
                    if (board[i][j] === 2) {
                        cell.classList.add('own-plane-head');
                        cell.textContent = 'âœˆ';
                    } else if (board[i][j] === 1) {
                        cell.classList.add('own-plane-body');
                        cell.textContent = 'â– ';
                    }
                    
                    // ã€æ–°å¢ã€‘å¦‚æœè¢«æ•Œæ–¹å‡»ä¸­ï¼Œè¦†ç›–æ˜¾ç¤ºå‡»ä¸­æ ‡è®°
                    if (isHitByEnemy) {
                        // æ¸…é™¤åŸæœ‰çš„é£æœºæ ·å¼å’Œæ–‡å­—
                        cell.className = 'cell';  // é‡ç½®class
                        if (isHeadHit) {
                            cell.classList.add('hit-head');
                            cell.textContent = 'ğŸ’¥';  // æœºå¤´è¢«å‡»ä¸­
                        } else {
                            cell.classList.add('hit-body');
                            cell.textContent = 'â—';  // æœºèº«è¢«å‡»ä¸­
                        }
                    }
                    
                    grid.appendChild(cell);
                }
            }
            document.getElementById('myPlanesLeft').innerText = `é£æœº: ${roomData.planes[myPlayerNum]}`;
        }
        
        function renderEnemyBoard(roomData, playerNum) {
            const grid = document.getElementById(`enemyGrid${playerNum}`);
            if (!grid) return;
            grid.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    const key = `${playerNum}-${i}-${j}`;
                    const attack = roomData.attacks[key];
                    
                    if (attack) {
                        if (attack.hit) {
                            if (attack.head) {
                                cell.classList.add('hit-head');
                                cell.textContent = 'ğŸ’¥';
                            } else {
                                cell.classList.add('hit-body');
                                cell.textContent = 'â—';
                            }
                        } else {
                            cell.classList.add('miss');
                            cell.textContent = 'Ã—';
                        }
                    } else {
                        cell.classList.add('enemy-unknown');
                    }
                    
                    if (isMyTurn(roomData) && 
                        !roomData.eliminated[playerNum] && 
                        window.selectedTarget === playerNum) {
                        cell.classList.add('enemy-cell');
                        cell.onclick = () => attackEnemy(playerNum, i, j);
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            document.getElementById(`enemyPlanes${playerNum}`).innerText = `é£æœº: ${roomData.eliminated[playerNum] ? 0 : roomData.planes[playerNum]}`;
            document.getElementById(`enemyTitle${playerNum}`).innerHTML = `ğŸ‘¤ ç©å®¶${playerNum} ${roomData.eliminated[playerNum] ? '[å·²æ·˜æ±°]' : ''}`;
        }
        function renderEnemyBoard(roomData, playerNum) {
            const grid = document.getElementById(`enemyGrid${playerNum}`);
            if (!grid) return;
            grid.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    const key = `${playerNum}-${i}-${j}`;
                    const attack = roomData.attacks[key];
                    
                    if (attack) {
                        if (attack.hit) {
                            if (attack.head) {
                                cell.classList.add('hit-head');
                                cell.textContent = 'ğŸ’¥';
                            } else {
                                cell.classList.add('hit-body');
                                cell.textContent = 'â—';
                            }
                        } else {
                            cell.classList.add('miss');
                            cell.textContent = 'Ã—';
                        }
                    } else {
                        cell.classList.add('enemy-unknown');
                    }
                    
                    if (isMyTurn(roomData) && 
                        !roomData.eliminated[playerNum] && 
                        window.selectedTarget === playerNum) {
                        cell.classList.add('enemy-cell');
                        cell.onclick = () => attackEnemy(playerNum, i, j);
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            document.getElementById(`enemyPlanes${playerNum}`).innerText = `é£æœº: ${roomData.eliminated[playerNum] ? 0 : roomData.planes[playerNum]}`;
            document.getElementById(`enemyTitle${playerNum}`).innerHTML = `ğŸ‘¤ ç©å®¶${playerNum} ${roomData.eliminated[playerNum] ? '[å·²æ·˜æ±°]' : ''}`;
        }
        
        function renderAllEnemyBoards(roomData) {
            for (let i = 1; i <= 3; i++) {
                if (i !== myPlayerNum) renderEnemyBoard(roomData, i);
            }
        }
        
        function attackEnemy(target, row, col) {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            if (!isMyTurn(roomData)) { alert('ä¸æ˜¯ä½ çš„å›åˆ'); return; }
            if (roomData.eliminated[target]) { alert('è¯¥ç©å®¶å·²æ·˜æ±°'); return; }
            
            const key = `${target}-${row}-${col}`;
            if (roomData.attacks[key]) { alert('å·²ç»æ”»å‡»è¿‡è¿™é‡Œ'); return; }
            
            const board = roomData.boards[target];
            const value = board[row][col];
            const isHit = value !== 0;
            const isHead = value === 2;
            
            roomData.attacks[key] = { hit: isHit, head: isHead };
            
            let msg = '';
            if (isHit) {
                if (isHead) {
                    roomData.planes[target]--;
                    msg = `ğŸ’¥ å‡»ä¸­æœºå¤´ï¼ç©å®¶${target}é£æœº-1`;
                    if (roomData.planes[target] === 0) {
                        roomData.eliminated[target] = true;
                        msg += ` ç©å®¶${target}è¢«æ·˜æ±°ï¼`;
                        
                        const alive = [1,2,3].filter(p => !roomData.eliminated[p]);
                        if (alive.length === 1) {
                            msg += ` ğŸ† ç©å®¶${alive[0]}è·èƒœï¼`;
                            alert(msg);
                            return;
                        }
                    }
                } else {
                    msg = `ğŸ¯ å‡»ä¸­æœºèº«ï¼`;
                }
            } else {
                msg = `ğŸ’§ æœªå‡»ä¸­`;
            }
            
            saveRoom(myRoomCode, roomData);
            
            renderEnemyBoard(roomData, target);
            alert(msg);
            
            window.selectedTarget = null;
            nextTurn(roomData);
        }
        
        function nextTurn(roomData) {
            const alive = [1,2,3].filter(p => !roomData.eliminated[p]);
            if (alive.length <= 1) return;
            
            let next = roomData.turn;
            do {
                next = next === 3 ? 1 : next + 1;
            } while (!alive.includes(next));
            
            roomData.turn = next;
            saveRoom(myRoomCode, roomData);
            
            refreshGameUI();
        }
        
        function isMyTurn(roomData) {
            return roomData.turn === myPlayerNum;
        }
        
        function updateTurnDisplay(roomData) {
            const el = document.getElementById('turnDisplay');
            if (isMyTurn(roomData)) {
                el.innerHTML = 'âš”ï¸ ä½ çš„å›åˆï¼é€‰æ‹©ç›®æ ‡';
                el.style.background = '#48bb78';
            } else {
                el.innerHTML = `ğŸ‘€ ç©å®¶${roomData.turn}çš„å›åˆ`;
                el.style.background = '#ed8936';
            }
        }
        
        function showTargetSelector(roomData) {
            const sel = document.getElementById('targetSelector');
            sel.innerHTML = '';
            sel.classList.remove('hidden');
            
            const alive = [1,2,3].filter(p => !roomData.eliminated[p] && p !== myPlayerNum);
            
            alive.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'target-btn';
                btn.innerText = `ğŸ¯ æ”»å‡»ç©å®¶${p}`;
                btn.onclick = () => {
                    window.selectedTarget = p;
                    document.querySelectorAll('.target-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    refreshGameUI();
                };
                sel.appendChild(btn);
            });
        }
        
        function hideTargetSelector() {
            document.getElementById('targetSelector').classList.add('hidden');
            window.selectedTarget = null;
        }
        
        // ==================== åŒæ­¥æœºåˆ¶ ====================
        function startSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                if (myRoomCode) {
                    if (document.getElementById('roomInfo').classList.contains('hidden') === false) {
                        updateUI();
                    }
                    if (document.getElementById('gamePage').classList.contains('hidden') === false) {
                        refreshGameUI();
                    }
                }
            }, 500);
        }
        
        function backToMenu() {
            if (syncInterval) clearInterval(syncInterval);
            window.location.href = window.location.href.split('?')[0];
        }
        
        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            const player = urlParams.get('player');
            
            if (room && player) {
                myRoomCode = room;
                myPlayerNum = parseInt(player);
                
                let roomData = getRoom(room);
                if (!roomData) {
                    roomData = {
                        code: room,
                        players: [],
                        ready: {},
                        boards: {
                            1: generateBoard(),
                            2: generateBoard(),
                            3: generateBoard()
                        },
                        attacks: {},
                        planes: {1: 3, 2: 3, 3: 3},
                        eliminated: {},
                        turn: 1,
                        started: false
                    };
                }
                
                if (!roomData.players.includes(myPlayerNum)) {
                    roomData.players.push(myPlayerNum);
                    roomData.ready[myPlayerNum] = false;
                    saveRoom(room, roomData);
                }
                
                showRoom();
                startSync();
            }
        };
    </script>
</body>
</html>
