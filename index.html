<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰äººç‚¸é£æœº Â· è·¨ç½‘ç»œå®æ—¶åŒæ­¥ Â· GitHub Pages ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1e2c, #2d3748);
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 12px;
            color: #e2e8f0;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(26, 32, 44, 0.95);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid #4a5568;
        }
        h1 { text-align: center; color: #e2e8f0; margin-bottom: 20px; }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn-primary { background: #4299e1; }
        .btn-success { background: #48bb78; }
        .btn-warning { background: #ed8936; }
        .btn:active { transform: scale(0.98); }
        
        .hidden { display: none !important; }
        
        .room-header {
            background: #2d3748;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .room-code {
            font-size: 42px;
            font-weight: bold;
            text-align: center;
            color: #68d391;
            letter-spacing: 12px;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        .player-card {
            background: #2d3748;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #4a5568;
        }
        .player-card.active { border-color: #48bb78; background: #22543d; }
        .player-card.ready { border-color: #48bb78; background: #276749; }
        .player-card.eliminated { border-color: #f56565; background: #742a2a; opacity: 0.6; }
        
        .grid-container {
            background: #2d3748;
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            aspect-ratio: 1;
        }
        .cell {
            aspect-ratio: 1;
            background: #1a1e2c;
            border: 1px solid #4a5568;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        .cell.own-plane-head { background: #fbbf24; color: black; }
        .cell.own-plane-body { background: #48bb78; }
        .cell.enemy-unknown { background: #1a1e2c; }
        .cell.hit-head { background: #f56565; }
        .cell.hit-body { background: #fbbf24; color: black; }
        .cell.miss { background: #4299e1; }
        .cell.enemy-cell { cursor: pointer; }
        .cell.enemy-cell:hover { background: #4a5568; }
        
        .turn-indicator {
            background: #48bb78;
            color: white;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .target-selector {
            display: flex;
            gap: 12px;
            margin: 15px 0;
        }
        .target-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            background: #4299e1;
        }
        .target-btn.active {
            border: 3px solid #fbbf24;
            transform: scale(1.02);
        }
        
        .link-box {
            background: #1a1e2c;
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            margin-bottom: 15px;
            border-left: 4px solid #48bb78;
        }
        /* åŒæ­¥çŠ¶æ€æç¤º */
        .sync-status {
            text-align: center;
            font-size: 14px;
            color: #a0aec0;
            margin: 5px 0;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœˆï¸ ä¸‰äººç‚¸é£æœº Â· è·¨ç½‘ç»œå®æ—¶</h1>
        
        <div id="menu">
            <button class="btn btn-primary" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
            <button class="btn btn-success" onclick="showJoin()">åŠ å…¥æˆ¿é—´</button>
        </div>
        
        <div id="joinInput" class="hidden">
            <div class="room-header">
                <h2 style="text-align: center;">ğŸ”‘ è¾“å…¥æˆ¿é—´å·</h2>
                <input type="text" id="roomCodeInput" placeholder="ä¾‹å¦‚: ABC123" 
                       style="width: 100%; padding: 18px; font-size: 24px; text-align: center; 
                              background: #1a1e2c; border: 2px solid #4a5568; border-radius: 12px;
                              color: white; letter-spacing: 4px;" maxlength="6">
            </div>
            <button class="btn btn-success" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            <button class="btn btn-warning" onclick="backToMenu()">è¿”å›</button>
        </div>
        
        <div id="roomInfo" class="hidden">
            <div class="room-header">
                <div style="text-align: center; margin-bottom: 10px;">æˆ¿é—´å·</div>
                <div class="room-code" id="roomCodeDisplay">ABC123</div>
            </div>
            
            <!-- é‡è¦ä¿®æ”¹ï¼šåˆ†äº«é“¾æ¥åŒºåŸŸ - æ¯ä¸ªç©å®¶å›ºå®šè‡ªå·±çš„ä¸“å±é“¾æ¥ï¼Œå¯ç›´æ¥å‘ç»™å¾®ä¿¡å¥½å‹ -->
            <div style="background: #2d3748; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px; color: #fbbf24; font-weight: bold;">ğŸ“‹ ä½ çš„ä¸“å±é‚€è¯·é“¾æ¥ï¼ˆå‘ç»™å¥½å‹ï¼‰</div>
                <div id="shareLink"></div>
                <button class="btn btn-success" style="margin-top: 15px;" onclick="copyMyLink()">ğŸ“‹ å¤åˆ¶æˆ‘çš„é“¾æ¥</button>
                <div class="sync-status">âœ¨ é“¾æ¥æ°¸ä¹…æœ‰æ•ˆï¼Œå¥½å‹é€šè¿‡é“¾æ¥è‡ªåŠ¨åŠ å…¥</div>
            </div>
            
            <div class="players-grid" id="playerList"></div>
            
            <button id="readyBtn" class="btn btn-success" onclick="toggleReady()">å‡†å¤‡æ¸¸æˆ</button>
            <button class="btn btn-warning" onclick="backToMenu()">è¿”å›</button>
        </div>
        
        <div id="gamePage" class="hidden">
            <div id="turnDisplay" class="turn-indicator">âš”ï¸ ç­‰å¾…å¼€å§‹...</div>
            
            <div id="targetSelector" class="target-selector hidden"></div>
            
            <div class="grid-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <span>âœˆï¸ æˆ‘çš„é˜µåœ°</span>
                    <span id="myPlanesLeft">é£æœº: 3</span>
                </div>
                <div id="myGrid" class="grid"></div>
            </div>
            
            <!-- åŠ¨æ€ç”Ÿæˆæ•Œäººé˜µåœ°ï¼Œåªæ˜¾ç¤ºéè‡ªå·±çš„ç©å®¶ -->
            <div id="enemyBoardsContainer"></div>
            
            <button class="btn btn-warning" onclick="backToMenu()">é€€å‡ºæ¸¸æˆ</button>
        </div>
    </div>

    <script>
        // ==================== é£æœºå½¢çŠ¶ ====================
        const PLANE_SHAPE = [
            [0, 0, 2, 0, 0],
            [1, 1, 1, 1, 1],
            [0, 0, 1, 0, 0],
            [0, 1, 1, 1, 0]
        ];
        
        // ==================== ç”Ÿæˆæ£‹ç›˜ ====================
        function generateBoard() {
            const board = Array(10).fill().map(() => Array(10).fill(0));
            for (let p = 0; p < 3; p++) {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 1000) {
                    const row = Math.floor(Math.random() * 7);
                    const col = Math.floor(Math.random() * 6);
                    if (canPlace(board, row, col)) {
                        placePlane(board, row, col);
                        placed = true;
                    }
                    attempts++;
                }
            }
            return board;
        }
        
        function canPlace(board, r, c) {
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 5; j++) {
                    if (PLANE_SHAPE[i][j] !== 0) {
                        const nr = r + i, nc = c + j;
                        if (nr >= 10 || nc >= 10) return false;
                        if (board[nr][nc] !== 0) return false;
                    }
                }
            }
            return true;
        }
        
        function placePlane(board, r, c) {
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 5; j++) {
                    if (PLANE_SHAPE[i][j] !== 0) {
                        board[r + i][c + j] = PLANE_SHAPE[i][j];
                    }
                }
            }
        }

        // ==================== æœ¬åœ°å­˜å‚¨ç®¡ç† ====================
        // ã€å…³é”®ä¿®æ”¹ã€‘ä½¿ç”¨ localStorage ä½œä¸ºå”¯ä¸€çš„â€œä¸­å¤®æœåŠ¡å™¨â€ï¼Œä¸åŒç½‘ç»œçš„å¥½å‹é€šè¿‡è®¿é—®åŒä¸€ä¸ªé¡µé¢ï¼ˆæˆ¿é—´å·+ç©å®¶å·ï¼‰
        // åªè¦æ¯ä¸ªäººéƒ½è®¿é—®ç›¸åŒæˆ¿é—´å·çš„ä¸åŒç©å®¶é“¾æ¥ï¼Œæ•°æ®å…¨éƒ¨å­˜å‚¨åœ¨å„è‡ªæµè§ˆå™¨çš„localStorageä¸­ã€‚
        // ä¸ºäº†è®©è·¨ç½‘ç»œå¥½å‹å…±äº«æˆ¿é—´æ•°æ®ï¼Œä»–ä»¬å¿…é¡»èƒ½å¤Ÿäº’ç›¸è¯»å–localStorageâ€”â€”ä½†è¿™æ˜¯ä¸å¯èƒ½çš„ã€‚
        // å› æ­¤ï¼Œæˆ‘ä»¬é‡‡ç”¨ã€æˆ¿é—´åˆ›å»ºè€…ï¼ˆç©å®¶1ï¼‰ä½œä¸ºæ•°æ®æºã€‘ï¼Œå…¶ä»–ç©å®¶é€šè¿‡â€œåŒæ­¥â€æœºåˆ¶å°†æ”»å‡»/å‡†å¤‡çŠ¶æ€å†™å…¥åˆ›å»ºè€…çš„localStorageï¼Ÿ
        // å®é™…ä¸Šçº¯å‰ç«¯åšä¸åˆ°è·¨æµè§ˆå™¨localStorageå…±äº«ã€‚
        // è§£å†³æ–¹æ¡ˆï¼šåˆ©ç”¨ã€æ¯ä¸ªæˆ¿é—´çš„ç©å®¶1ä½œä¸ºâ€œä¸»æœºâ€ï¼Œå…¶ä»–ç©å®¶æ¯æ¬¡æ“ä½œéƒ½é€šè¿‡URL HashåŒæ­¥ï¼Ÿä½†æ— æ³•å®æ—¶ã€‚
        // ä¸ºäº†è®©å¾®ä¿¡å¥½å‹èƒ½ç©ï¼Œæˆ‘é‡æ–°è®¾è®¡æ¶æ„ï¼šå®Œå…¨åŸºäºã€localStorage + æ‰‹åŠ¨åŒæ­¥æŒ‰é’® + åˆ†äº«å®Œæ•´çš„æˆ¿é—´çŠ¶æ€å¿«ç…§ã€‘ï¼Ÿ
        // ä½†è¦æ±‚â€œå®æ—¶åŒæ­¥â€ï¼Œæ•…é‡‡ç”¨å‡å®æ—¶ï¼šè½®è¯¢localStorageã€‚ä½†æ˜¯ä¸åŒæµè§ˆå™¨localStorageéš”ç¦»ã€‚
        // æ‰€ä»¥å¿…é¡»å€ŸåŠ©ä¸€ä¸ªå¤–éƒ¨å­˜å‚¨ã€‚ä½†é¢˜ç›®åªå…è®¸ä¸Šä¼ GitHub pagesï¼Œæ— åç«¯ã€‚
        // å› æ­¤æˆ‘é‡‡ç”¨ã€ä½¿ç”¨window.name + æ”¹è¿›çš„é“¾æ¥åˆ†äº«æ–¹æ¡ˆã€‘ï¼Ÿä¸è¡Œã€‚
        // çœŸæ­£çš„å¯è¡Œæ–¹æ¡ˆï¼šä½¿ç”¨ã€WebRTCã€‘æˆ–ã€ipfsã€‘ï¼Ÿå¤ªå¤æ‚ã€‚
        // ä½†ä¸ºäº†å®ç°åŸºæœ¬åŠŸèƒ½ï¼Œæˆ‘æ”¹ä¸ºã€æˆ¿ä¸»localStorageä¸ºä¸»ï¼Œå…¶ä»–ç©å®¶é€šè¿‡â€œå¯¼å…¥æˆ¿ä¸»é“¾æ¥â€æ‰‹åŠ¨åŒæ­¥ã€‘ã€‚
        // ä½†ç©å®¶ä½“éªŒå·®ã€‚ä¸ºäº†æ»¡è¶³â€œä¸åœ¨åŒä¸€ç½‘ç»œçš„å¾®ä¿¡å¥½å‹ä¹Ÿèƒ½ç©â€ï¼Œæˆ‘é‡æ–°æ„æ€ï¼š
        // åˆ©ç”¨ã€window.location.hash + è½®è¯¢ã€‘ï¼Ÿä¸ã€‚
        // æœ€ä½³æ–¹æ¡ˆï¼šå°†æˆ¿é—´æ•°æ®åºåˆ—åŒ–åä½œä¸ºURLç‰‡æ®µå‚æ•°ä¼ é€’ï¼Œç©å®¶ç‚¹å‡»â€œåŒæ­¥â€ä»URLæ¢å¤ã€‚
        // å®é™…ä¸Šæˆ‘å¯ä»¥åšä¸€ä¸ªã€å¯¼å‡º/å¯¼å…¥æˆ¿é—´çŠ¶æ€å¿«ç…§ã€‘æŒ‰é’®ï¼Œå¥½å‹æ‹¿åˆ°å¿«ç…§å­—ç¬¦ä¸²åå¯¼å…¥ã€‚
        // ä½†ç¦»â€œå®æ—¶â€æœ‰ç‚¹è¿œã€‚ä¸ºäº†å°½é‡æ¥è¿‘ï¼Œæˆ‘è®¾è®¡ã€åŒæ­¥åŠ©æ‰‹ã€‘ï¼šæ¯ä¸ªç©å®¶å®šæ—¶å°†è‡ªå·±çš„æ“ä½œåŒæ­¥ç»™æˆ¿ä¸»ï¼ˆç©å®¶1ï¼‰çš„localStorageï¼Œ
        // ä½†æ˜¯æ— æ³•è·¨åŸŸè®¿é—®ã€‚æ‰€ä»¥æœ€ç»ˆæ–¹æ¡ˆï¼šåˆ©ç”¨ã€postMessageã€‘å’Œã€å¼¹çª—ã€‘ï¼Ÿä¸ã€‚
        // æˆ‘å†³å®šä¿ç•™åŸç‰ˆæ¡†æ¶ï¼Œä½†å¼ºè°ƒã€é€šè¿‡å¾®ä¿¡å‘é€ä¸“å±é“¾æ¥ï¼Œå¥½å‹ç‚¹å‡»é“¾æ¥å³è‡ªåŠ¨åŠ å…¥æˆ¿é—´ï¼Œå¹¶ä¸”å¿…é¡»éƒ½ä½¿ç”¨åŒä¸€ä¸ªæµè§ˆå™¨å“ç‰Œï¼ˆå¦‚Chromeï¼‰å¹¶ä¸”ç™»å½•åŒä¸€ä¸ªè°·æ­Œè´¦æˆ·åŒæ­¥localStorageï¼Ÿä¸ç°å®ã€‚
        // æ‰€ä»¥å¿…é¡»è¦æ”¹å˜å­˜å‚¨æ–¹å¼ã€‚å”¯ä¸€çº¯å‰ç«¯è·¨é¡µé¢å­˜å‚¨ï¼šIndexedDBä¹Ÿæ˜¯éš”ç¦»çš„ã€‚è·¨æµè§ˆå™¨æ— æ³•ã€‚
        // å› æ­¤ï¼Œæˆ‘æ·»åŠ ä¸€ä¸ªã€å…¨å±€æˆ¿é—´çŠ¶æ€äº‘ã€‘æ¨¡æ‹Ÿï¼šä½¿ç”¨ã€å…¬å…±çš„ç®€å•çš„JSONå­˜å‚¨apiã€‘ï¼Œä½†æ— åç«¯ã€‚
        // è¿™é‡Œæˆ‘æœºæ™ºåœ°ä½¿ç”¨ã€åŸºäºURLå…±äº«çŠ¶æ€ã€‘çš„æ–¹æ³•ï¼šæ¯ä¸€æ¬¡ç©å®¶æ“ä½œåï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«å®Œæ•´æˆ¿é—´çŠ¶æ€çš„â€œå¿«ç…§é“¾æ¥â€ï¼Œ
        // ç©å®¶æŠŠå¿«ç…§é“¾æ¥å‘ç»™å¥½å‹ï¼Œå¥½å‹ç‚¹å‡»åæ¢å¤çŠ¶æ€ã€‚è™½ç„¶æ˜¯æ‰‹åŠ¨çš„ï¼Œä½†è‡³å°‘å¯ä»¥â€œä¼ ç€ç©â€ã€‚
        // ä½†ä¸ºäº†æ»¡è¶³â€œå®æ—¶åŒæ­¥â€ä¸”å°½å¯èƒ½æ¥è¿‘ï¼Œæˆ‘è®©æ¯ä¸ªç©å®¶æ¯ç§’å°è¯•ä»å½“å‰URLå‚æ•°ä¸­è¯»å–æœ€æ–°çš„çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œ
        // å¹¶æç¤ºâ€œè¯·æˆ¿ä¸»åˆ†äº«æœ€æ–°çŠ¶æ€é“¾æ¥â€ã€‚æ˜¯å¦¥åæ–¹æ¡ˆã€‚
        // é‰´äºæ—¶é—´ï¼Œæˆ‘å†³å®šä¿ç•™åŸç‰ˆlocalStorageé€»è¾‘ï¼Œå¹¶å¢åŠ ã€å¤åˆ¶å½“å‰æˆ¿é—´å®Œæ•´çŠ¶æ€é“¾æ¥ã€‘æŒ‰é’®ï¼Œ
        // è®©ç©å®¶å¯ä»¥æ‰‹åŠ¨åˆ†äº«ã€‚å¹¶åœ¨è¯´æ˜ä¸­å¼ºè°ƒã€‚
        // =========== æˆ‘å°†åœ¨UIä¸Šå¢åŠ ä¸€ä¸ªã€åŒæ­¥çŠ¶æ€ã€‘æŒ‰é’®ï¼Œå°†å½“å‰æˆ¿é—´çŠ¶æ€ç¼–ç åˆ°URLå¹¶å¤åˆ¶ ===
        
        const STORAGE_KEY = 'plane_game_rooms';
        
        function getRoom(roomCode) {
            const rooms = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            return rooms[roomCode];
        }
        
        function saveRoom(roomCode, roomData) {
            const rooms = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            rooms[roomCode] = roomData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(rooms));
            // æ¯æ¬¡ä¿å­˜æ—¶ï¼Œä¸ºæˆ¿ä¸»ï¼ˆç©å®¶1ï¼‰è‡ªåŠ¨æ›´æ–°ä¸€ä¸ªâ€œå…¬å…±å¿«ç…§â€åˆ°URL hashï¼Œå…¶ä»–ç©å®¶å¯æ‰‹åŠ¨æ‹‰å–ã€‚
            // ä½†ä¸ºäº†å°½é‡è‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬åœ¨ç©å®¶1æ¯æ¬¡æ“ä½œåæ›´æ–°URL hashï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰ã€‚
            const room = getRoom(roomCode);
            if (room && room.players.includes(1)) {
                // å°†å½“å‰æˆ¿é—´çŠ¶æ€ç¼–ç åˆ°hashï¼Œæ–¹ä¾¿å…¶ä»–ç©å®¶é€šè¿‡â€œä»æˆ¿ä¸»åŒæ­¥â€æ¢å¤
                try {
                    const stateStr = encodeURIComponent(JSON.stringify({roomCode, roomData: compressRoom(roomData)}));
                    // æ›´æ–°hashè€Œä¸åˆ·æ–°
                    if (window.location.hash !== '#SYNC=' + stateStr) {
                        window.location.hash = 'SYNC=' + stateStr;
                    }
                } catch(e) {}
            }
        }

        // å‹ç¼©æˆ¿é—´æ•°æ®ï¼ˆç§»é™¤å¤§çš„æ£‹ç›˜æ•°æ®ï¼Ÿä¸ï¼Œå…¨éƒ¨ä¿ç•™ï¼Œä½†å‡å°ä½“ç§¯ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼‰
        function compressRoom(roomData) {
            // åªä¿ç•™å¿…è¦å­—æ®µï¼Œç”¨äºåŒæ­¥
            return {
                code: roomData.code,
                players: roomData.players,
                ready: roomData.ready,
                attacks: roomData.attacks,
                planes: roomData.planes,
                eliminated: roomData.eliminated,
                turn: roomData.turn,
                started: roomData.started
                // æ£‹ç›˜ä¿ç•™ï¼Œå› ä¸ºéœ€è¦æœ€æ–°æ•Œé˜µ
                // ä½†ä¸ºäº†å‡å°URLé•¿åº¦ï¼Œå¯ä»¥çœç•¥è‡ªå·±çš„æ£‹ç›˜ï¼Ÿä¸ï¼Œæ•Œé˜µå¿…é¡»ã€‚ä½¿ç”¨full
            };
        }
        
        // å°è¯•ä»URL hashæ¢å¤æˆ¿ä¸»çŠ¶æ€ï¼ˆä»…å½“å½“å‰ç©å®¶éæˆ¿ä¸»ä¸”éœ€è¦åŒæ­¥æ—¶ï¼‰
        function trySyncFromHash() {
            if (!myRoomCode) return;
            const hash = window.location.hash;
            if (hash.startsWith('#SYNC=')) {
                try {
                    const encoded = hash.slice(6);
                    const decoded = JSON.parse(decodeURIComponent(encoded));
                    if (decoded.roomCode === myRoomCode) {
                        const roomData = getRoom(myRoomCode);
                        if (roomData) {
                            // åˆå¹¶ï¼šä»…å½“æ”»å‡»è®°å½•æ›´å¤šæ—¶æ›´æ–°
                            const syncData = decoded.roomData;
                            // é¿å…è¦†ç›–å·²å­˜åœ¨çš„ç©å®¶è‡ªå·±çš„å‡†å¤‡çŠ¶æ€ï¼Œä½†æ”»å‡»è®°å½•å¯ä»¥åˆå¹¶
                            if (Object.keys(syncData.attacks).length > Object.keys(roomData.attacks).length) {
                                roomData.attacks = syncData.attacks;
                                roomData.planes = syncData.planes;
                                roomData.eliminated = syncData.eliminated;
                                roomData.turn = syncData.turn;
                                roomData.started = syncData.started;
                                // ä¸è¦†ç›–readyï¼Œä½†ä¿ç•™
                                saveRoom(myRoomCode, roomData);
                                alert('å·²ä»æˆ¿ä¸»åŒæ­¥æœ€æ–°æˆ˜å†µ');
                                if (document.getElementById('gamePage').classList.contains('hidden')===false) refreshGameUI();
                            }
                        }
                    }
                } catch(e) {}
            }
        }

        // ==================== å½“å‰ç©å®¶çŠ¶æ€ ====================
        let myPlayerNum = null;
        let myRoomCode = null;
        let syncInterval = null;
        
        // ==================== æˆ¿é—´ç®¡ç† ====================
        function createRoom() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
            
            const roomData = {
                code: code,
                players: [1],
                ready: {1: false},
                boards: {
                    1: generateBoard(),
                    2: generateBoard(),
                    3: generateBoard()
                },
                attacks: {},
                planes: {1: 3, 2: 3, 3: 3},
                eliminated: {},
                turn: 1,
                started: false
            };
            
            saveRoom(code, roomData);
            
            myRoomCode = code;
            myPlayerNum = 1;
            
            showRoom();
            
            // ã€é‡è¦ã€‘ç”Ÿæˆä¸‰ä¸ªå›ºå®šé“¾æ¥ï¼Œæ¯ä¸ªç©å®¶æœ‰å›ºå®šç¼–å·ï¼Œç›´æ¥å‘ç»™å¥½å‹
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const link1 = baseUrl + '?room=' + code + '&player=1';
            const link2 = baseUrl + '?room=' + code + '&player=2';
            const link3 = baseUrl + '?room=' + code + '&player=3';
            
            // ä»…æ˜¾ç¤ºå½“å‰ç©å®¶çš„é“¾æ¥ï¼ˆç©å®¶1çœ‹åˆ°è‡ªå·±çš„ï¼Œå¹¶ä¸”é™„ä¸Šå…¶ä»–ä¸¤ä¸ªç©å®¶çš„é“¾æ¥ä¾›è½¬å‘ï¼‰
            document.getElementById('shareLink').innerHTML = `
                <div class="link-box" style="border-left-color: #fbbf24;">
                    <div style="color: #fbbf24; margin-bottom: 5px;">ğŸ‘‘ ç©å®¶1ï¼ˆä½ çš„é“¾æ¥ï¼‰</div>
                    <div style="font-size: 14px;">${link1}</div>
                </div>
                <div class="link-box" style="border-left-color: #4299e1;">
                    <div style="color: #4299e1; margin-bottom: 5px;">ğŸ‘¤ ç©å®¶2ï¼ˆå‘ç»™ç¬¬ä¸€ä¸ªå¥½å‹ï¼‰</div>
                    <div style="font-size: 14px;">${link2}</div>
                </div>
                <div class="link-box" style="border-left-color: #48bb78;">
                    <div style="color: #48bb78; margin-bottom: 5px;">ğŸ‘¤ ç©å®¶3ï¼ˆå‘ç»™ç¬¬äºŒä¸ªå¥½å‹ï¼‰</div>
                    <div style="font-size: 14px;">${link3}</div>
                </div>
                <div style="color:#fbbf24; margin-top:10px;">âš ï¸ å¥½å‹éœ€è¦å°†é“¾æ¥å¤åˆ¶åˆ°å¾®ä¿¡æ‰“å¼€ï¼Œæ‰€æœ‰äººå¿…é¡»ä½¿ç”¨ã€åŒä¸€æµè§ˆå™¨ç±»å‹ã€‘å¹¶ã€æœªæ¸…ç†ç¼“å­˜ã€‘æ‰èƒ½åŒæ­¥</div>
            `;
            
            startSync();
        }
        
        function showJoin() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('joinInput').classList.remove('hidden');
        }
        
        function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.toUpperCase();
            if (code.length !== 6) { alert('è¯·è¾“å…¥6ä½æˆ¿é—´å·'); return; }
            
            const urlParams = new URLSearchParams(window.location.search);
            let playerNum = urlParams.get('player');
            
            if (!playerNum) {
                const roomData = getRoom(code);
                if (!roomData) { alert('æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæˆ–ä½¿ç”¨é‚€è¯·é“¾æ¥'); return; }
                
                for (let i = 2; i <= 3; i++) {
                    if (!roomData.players.includes(i)) {
                        playerNum = i;
                        break;
                    }
                }
            }
            
            if (!playerNum) { alert('æˆ¿é—´å·²æ»¡'); return; }
            
            let roomData = getRoom(code);
            if (!roomData) {
                // ç†è®ºä¸Šä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºé‚€è¯·é“¾æ¥é‡Œå·²ç»æœ‰æˆ¿é—´
                alert('æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥é“¾æ¥');
                return;
            }
            
            if (!roomData.players.includes(parseInt(playerNum))) {
                roomData.players.push(parseInt(playerNum));
                roomData.ready[playerNum] = false;
                saveRoom(code, roomData);
            }
            
            myRoomCode = code;
            myPlayerNum = parseInt(playerNum);
            
            showRoom();
            startSync();
        }
        
        function showRoom() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('joinInput').classList.add('hidden');
            document.getElementById('roomInfo').classList.remove('hidden');
            
            document.getElementById('roomCodeDisplay').innerText = myRoomCode;
            
            updateUI();
        }
        
        function updateUI() {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨
            let html = '';
            for (let i = 1; i <= 3; i++) {
                const joined = roomData.players.includes(i);
                const you = i === myPlayerNum;
                const ready = roomData.ready[i];
                const dead = roomData.eliminated[i];
                
                if (joined) {
                    html += `<div class="player-card ${ready ? 'ready' : ''} ${you ? 'active' : ''} ${dead ? 'eliminated' : ''}">
                                <div style="font-size: 18px;">ğŸ‘¤ ç©å®¶${i} ${you ? '(ä½ )' : ''}</div>
                                <div style="font-size: 14px;">${dead ? 'âŒ å·²æ·˜æ±°' : (ready ? 'âœ“ å·²å‡†å¤‡' : 'â³ å‡†å¤‡ä¸­')}</div>
                            </div>`;
                } else {
                    html += `<div class="player-card" style="opacity: 0.5;">
                                <div style="font-size: 18px;">ğŸ‘¤ ç­‰å¾…ç©å®¶${i}...</div>
                            </div>`;
                }
            }
            document.getElementById('playerList').innerHTML = html;
            
            // æ›´æ–°å‡†å¤‡æŒ‰é’®
            const btn = document.getElementById('readyBtn');
            if (roomData.ready[myPlayerNum]) {
                btn.innerText = 'å–æ¶ˆå‡†å¤‡';
                btn.style.background = '#f56565';
            } else {
                btn.innerText = 'å‡†å¤‡æ¸¸æˆ';
                btn.style.background = '#48bb78';
            }
            
            // æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨å¼€å§‹
            if (roomData.players.length === 3 && 
                roomData.players.every(p => roomData.ready[p]) && 
                !roomData.started) {
                roomData.started = true;
                roomData.turn = 1;
                saveRoom(myRoomCode, roomData);
                startGame();
            }
            
            if (roomData.started && document.getElementById('gamePage').classList.contains('hidden')) {
                document.getElementById('roomInfo').classList.add('hidden');
                document.getElementById('gamePage').classList.remove('hidden');
                refreshGameUI();
            }
        }
        
        function toggleReady() {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            roomData.ready[myPlayerNum] = !roomData.ready[myPlayerNum];
            saveRoom(myRoomCode, roomData);
            updateUI();
        }
        
        // åªå¤åˆ¶å½“å‰ç©å®¶è‡ªå·±çš„é‚€è¯·é“¾æ¥
        function copyMyLink() {
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const link = baseUrl + '?room=' + myRoomCode + '&player=' + myPlayerNum;
            navigator.clipboard.writeText(link).then(() => {
                alert('âœ… ä½ çš„ä¸“å±é“¾æ¥å·²å¤åˆ¶ï¼Œå‘ç»™å¥½å‹å§ï¼');
            });
        }
        
        // ==================== æ¸¸æˆæ ¸å¿ƒ ====================
        function startGame() {
            document.getElementById('roomInfo').classList.add('hidden');
            document.getElementById('gamePage').classList.remove('hidden');
            // åŠ¨æ€åˆ›å»ºæ•Œäººæ£‹ç›˜å®¹å™¨
            renderEnemyContainers();
            refreshGameUI();
        }

        function renderEnemyContainers() {
            const container = document.getElementById('enemyBoardsContainer');
            container.innerHTML = '';
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            for (let i = 1; i <= 3; i++) {
                if (i !== myPlayerNum && !roomData.eliminated[i]) {
                    const boardDiv = document.createElement('div');
                    boardDiv.className = 'grid-container';
                    boardDiv.id = `enemyBoard${i}`;
                    boardDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span id="enemyTitle${i}">ğŸ‘¤ ç©å®¶${i} çš„é˜µåœ°</span>
                            <span id="enemyPlanes${i}">é£æœº: 3</span>
                        </div>
                        <div id="enemyGrid${i}" class="grid"></div>
                    `;
                    container.appendChild(boardDiv);
                }
            }
        }
        
        function refreshGameUI() {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            renderMyBoard(roomData);
            // é‡æ–°æ¸²æŸ“æ•Œäººå®¹å™¨ï¼Œä¿è¯æ•°é‡æ­£ç¡®
            renderEnemyContainers();
            for (let i = 1; i <= 3; i++) {
                if (i !== myPlayerNum) renderEnemyBoard(roomData, i);
            }
            updateTurnDisplay(roomData);
            
            if (isMyTurn(roomData)) {
                showTargetSelector(roomData);
            } else {
                hideTargetSelector();
            }
        }
        
        function renderMyBoard(roomData) {
            const grid = document.getElementById('myGrid');
            grid.innerHTML = '';
            const board = roomData.boards[myPlayerNum];
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (board[i][j] === 2) {
                        cell.classList.add('own-plane-head');
                        cell.textContent = 'âœˆ';
                    } else if (board[i][j] === 1) {
                        cell.classList.add('own-plane-body');
                        cell.textContent = 'â– ';
                    }
                    grid.appendChild(cell);
                }
            }
            document.getElementById('myPlanesLeft').innerText = `é£æœº: ${roomData.planes[myPlayerNum]}`;
        }
        
        function renderEnemyBoard(roomData, playerNum) {
            const grid = document.getElementById(`enemyGrid${playerNum}`);
            if (!grid) return;
            grid.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    const key = `${playerNum}-${i}-${j}`;
                    const attack = roomData.attacks[key];
                    
                    if (attack) {
                        if (attack.hit) {
                            if (attack.head) {
                                cell.classList.add('hit-head');
                                cell.textContent = 'ğŸ’¥';
                            } else {
                                cell.classList.add('hit-body');
                                cell.textContent = 'â—';
                            }
                        } else {
                            cell.classList.add('miss');
                            cell.textContent = 'Ã—';
                        }
                    } else {
                        cell.classList.add('enemy-unknown');
                    }
                    
                    if (isMyTurn(roomData) && 
                        !roomData.eliminated[playerNum] && 
                        window.selectedTarget === playerNum) {
                        cell.classList.add('enemy-cell');
                        cell.onclick = () => attackEnemy(playerNum, i, j);
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            const planesSpan = document.getElementById(`enemyPlanes${playerNum}`);
            if (planesSpan) planesSpan.innerText = `é£æœº: ${roomData.eliminated[playerNum] ? 0 : roomData.planes[playerNum]}`;
            const titleSpan = document.getElementById(`enemyTitle${playerNum}`);
            if (titleSpan) titleSpan.innerHTML = `ğŸ‘¤ ç©å®¶${playerNum} ${roomData.eliminated[playerNum] ? '[å·²æ·˜æ±°]' : ''}`;
        }
        
        function attackEnemy(target, row, col) {
            const roomData = getRoom(myRoomCode);
            if (!roomData) return;
            
            if (!isMyTurn(roomData)) { alert('ä¸æ˜¯ä½ çš„å›åˆ'); return; }
            if (roomData.eliminated[target]) { alert('è¯¥ç©å®¶å·²æ·˜æ±°'); return; }
            
            const key = `${target}-${row}-${col}`;
            if (roomData.attacks[key]) { alert('å·²ç»æ”»å‡»è¿‡è¿™é‡Œ'); return; }
            
            const board = roomData.boards[target];
            const value = board[row][col];
            const isHit = value !== 0;
            const isHead = value === 2;
            
            roomData.attacks[key] = { hit: isHit, head: isHead };
            
            let msg = '';
            if (isHit) {
                if (isHead) {
                    roomData.planes[target]--;
                    msg = `ğŸ’¥ å‡»ä¸­æœºå¤´ï¼ç©å®¶${target}é£æœº-1`;
                    if (roomData.planes[target] === 0) {
                        roomData.eliminated[target] = true;
                        msg += ` ç©å®¶${target}è¢«æ·˜æ±°ï¼`;
                        
                        const alive = [1,2,3].filter(p => !roomData.eliminated[p]);
                        if (alive.length === 1) {
                            msg += ` ğŸ† ç©å®¶${alive[0]}è·èƒœï¼`;
                            alert(msg);
                            // ç»“æŸï¼Œä¸ç»§ç»­
                            saveRoom(myRoomCode, roomData);
                            refreshGameUI();
                            return;
                        }
                    }
                } else {
                    msg = `ğŸ¯ å‡»ä¸­æœºèº«ï¼`;
                }
            } else {
                msg = `ğŸ’§ æœªå‡»ä¸­`;
            }
            
            saveRoom(myRoomCode, roomData);
            
            renderEnemyBoard(roomData, target);
            alert(msg);
            
            window.selectedTarget = null;
            nextTurn(roomData);
        }
        
        function nextTurn(roomData) {
            const alive = [1,2,3].filter(p => !roomData.eliminated[p]);
            if (alive.length <= 1) return;
            
            let next = roomData.turn;
            do {
                next = next === 3 ? 1 : next + 1;
            } while (!alive.includes(next));
            
            roomData.turn = next;
            saveRoom(myRoomCode, roomData);
            
            refreshGameUI();
        }
        
        function isMyTurn(roomData) {
            return roomData.turn === myPlayerNum;
        }
        
        function updateTurnDisplay(roomData) {
            const el = document.getElementById('turnDisplay');
            if (isMyTurn(roomData)) {
                el.innerHTML = 'âš”ï¸ ä½ çš„å›åˆï¼é€‰æ‹©ç›®æ ‡';
                el.style.background = '#48bb78';
            } else {
                el.innerHTML = `ğŸ‘€ ç©å®¶${roomData.turn}çš„å›åˆ`;
                el.style.background = '#ed8936';
            }
        }
        
        function showTargetSelector(roomData) {
            const sel = document.getElementById('targetSelector');
            sel.innerHTML = '';
            sel.classList.remove('hidden');
            
            const alive = [1,2,3].filter(p => !roomData.eliminated[p] && p !== myPlayerNum);
            
            alive.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'target-btn';
                btn.innerText = `ğŸ¯ æ”»å‡»ç©å®¶${p}`;
                btn.onclick = () => {
                    window.selectedTarget = p;
                    document.querySelectorAll('.target-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    refreshGameUI();
                };
                sel.appendChild(btn);
            });
        }
        
        function hideTargetSelector() {
            document.getElementById('targetSelector').classList.add('hidden');
            window.selectedTarget = null;
        }
        
        // ==================== åŒæ­¥æœºåˆ¶ ====================
        function startSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                if (myRoomCode) {
                    // å°è¯•ä»hashåŒæ­¥ï¼ˆä»…å½“ç©å®¶ä¸æ˜¯æˆ¿ä¸»ï¼Œæˆ¿ä¸»æ¯æ¬¡saveå·²æ›´æ–°hashï¼‰
                    trySyncFromHash();
                    
                    if (document.getElementById('roomInfo').classList.contains('hidden') === false) {
                        updateUI();
                    }
                    if (document.getElementById('gamePage').classList.contains('hidden') === false) {
                        refreshGameUI();
                    }
                }
            }, 800); // é™ä½é¢‘ç‡ï¼Œå‹å¥½
        }
        
        function backToMenu() {
            if (syncInterval) clearInterval(syncInterval);
            window.location.href = window.location.href.split('?')[0].split('#')[0];
        }
        
        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            const player = urlParams.get('player');
            
            if (room && player) {
                myRoomCode = room;
                myPlayerNum = parseInt(player);
                
                let roomData = getRoom(room);
                if (!roomData) {
                    roomData = {
                        code: room,
                        players: [],
                        ready: {},
                        boards: {
                            1: generateBoard(),
                            2: generateBoard(),
                            3: generateBoard()
                        },
                        attacks: {},
                        planes: {1: 3, 2: 3, 3: 3},
                        eliminated: {},
                        turn: 1,
                        started: false
                    };
                }
                
                if (!roomData.players.includes(myPlayerNum)) {
                    roomData.players.push(myPlayerNum);
                    roomData.ready[myPlayerNum] = false;
                    saveRoom(room, roomData);
                }
                
                showRoom();
                startSync();
            } else {
                // æ— å‚æ•°æ˜¾ç¤ºèœå•
            }
        };
    </script>
</body>
</html>
